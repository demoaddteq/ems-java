/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.mm.struts.student.action; 
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.StringTokenizer;
import java.util.Vector;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.sql.DataSource;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import com.mm.core.master.*;


import com.mm.struts.student.form.WriteComplaintForm;
/** 
 * MyEclipse Struts
 * Creation date: 06-11-2007
 * 
 * XDoclet definition:
 * @struts.action path="/writeComplaint" name="writeComplaintForm" input="/form/writeComplaint.jsp" scope="request" validate="true"
 * @struts.action-forward name="success" path="writeComplaint.jsp"
 */
public class eBillsAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception 
			{
		
		WriteComplaintForm writeComplaintForm = (WriteComplaintForm) form;// TODO Auto-generated method stub
		RootMaster rootMaster = new RootMaster();
		
		IndvMaster im = new IndvMaster();
		
		HttpSession session =request.getSession();
		String numCount = (String)session.getAttribute("numCount");
		int count = Integer.parseInt(numCount);
		int remander = count%2;
		

		java.util.Date dt = new java.util.Date();
		SimpleDateFormat sform = new SimpleDateFormat("yyyy-MM-dd");
		String completeRemDate = sform.format(dt);
		StringTokenizer sttotal = new StringTokenizer(completeRemDate, ",");
	    String creationDate = sttotal.nextToken();
	    
//	    System.out.println("Date "+creationDate);
	    
	    String dateToday[] = creationDate.split("-");
	    //System.out.println("Date Today"+dateToday);
	    String YR =dateToday[0];	
//	   System.out.println("Year "+YR);

	    String DaY = dateToday[2];
	//    System.out.println("Day "+DaY);
	    String MTH =dateToday[1];
	//    System.out.println("month "+MTH);
		String pageid = (request.getParameter("pageid")!=null) ? request.getParameter("pageid").trim() :(String)session.getAttribute("pageid");
		String lowerSubTag = (request.getParameter("lowerSubTag")!=null) ? request.getParameter("lowerSubTag").trim() :(String)session.getAttribute("lowerSubTag");
	
		String userid= (request.getParameter("uId") != null) ? request.getParameter("uId") : (String)session.getAttribute("uId");
		String qtype= (request.getParameter("qtype") != null) ? request.getParameter("qtype") : "Personal";
		session.setAttribute("uId",userid);
		
		String facId= (request.getParameter("fId") != null) ? request.getParameter("fId") : (String)session.getAttribute("fId");
		session.setAttribute("fId",facId);
		
		String companyid= (request.getParameter("compId") != null) ? request.getParameter("compId") : (String)session.getAttribute("compId");
		session.setAttribute("compId",companyid);
		System.out.println("pageid......on exis Req.........." +pageid);
		System.out.println("user ID......on exis Req..........." +userid);
		System.out.println("facility Id........." +facId);
		
		String month= (request.getParameter("Month") != null) ? request.getParameter("Month") : MTH;
		String nYear= (request.getParameter("Year") != null) ? request.getParameter("Year") : YR;	
		
		System.out.println("Month and Year are "+month+" "+nYear);

		IndvMaster indvMaster= new IndvMaster();		
		Vector dataVec = new Vector();		
		dataVec.add(userid);
		dataVec.add(companyid);		
		dataVec.add(qtype);
		dataVec.add(month);	
		dataVec.add(nYear);	
			
		Vector countVec = indvMaster.complaintCount(getDataSource(request, "student"), dataVec);		
		session.setAttribute("countVec", countVec);						
		//////System.out.println("countVec.............InboxAction........... "+countVec);
		
		
		String strShortBy = (request.getParameter("sby")!=null) ? request.getParameter("sby") : "creation_date";
		String strSOrder = "";
		String strComplaintFId = "asc";
		String strComplaintTitle = "asc";
		String strComplaintDate = "asc";
		if(request.getParameter("sby")!=null)
		{
			if(request.getParameter("cidorder")!=null)
			{
				if(request.getParameter("cidorder").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strComplaintFId = "desc";
				}
				else if (request.getParameter("cidorder").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strComplaintFId = "asc";
				}
			}
			
			if(request.getParameter("ctorder")!=null)
			{
				if(request.getParameter("ctorder").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strComplaintTitle = "desc";
				}
				else if (request.getParameter("ctorder").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strComplaintTitle = "asc";
				}
			}
			if(request.getParameter("cdorder")!=null)
			{
				if(request.getParameter("cdorder").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strComplaintDate = "desc";
				}
				else if (request.getParameter("cdorder").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strComplaintDate = "asc";
				}
			}
			
			
			
		}
		String strFShortBy = strShortBy+" "+strSOrder;
		int minVal = (request.getParameter("numMin")!=null) ? Integer.parseInt(request.getParameter("numMin")) : 0;
		int maxVal = 20;
		//////System.out.println("countVec.............InboxAction......minVal..... "+minVal);
		String status="2";
		String type="1";
		
		DataSource dataSource = getDataSource(request, "student");

		Vector<String> paramVec = new Vector<String>();
		paramVec.add(userid);
		paramVec.add(companyid);
		paramVec.add(status);	
		paramVec.add(type);
		paramVec.add(month);
		paramVec.add(nYear);
		
		int numCountBill1= indvMaster.eBillcount1(dataSource, paramVec);
		Vector userVec = indvMaster.eBills(dataSource, paramVec);
		
		type="0";
		Vector<String> paramVec1 = new Vector<String>();
		paramVec1.add(userid);
		paramVec1.add(companyid);
		paramVec1.add(status);	
		paramVec1.add(type);
		paramVec1.add(month);
		paramVec1.add(nYear);
		
		int numCountBill2= indvMaster.eBillcount1(dataSource, paramVec1);
		Vector userVec1 = indvMaster.eBills(dataSource, paramVec1);
		
		System.out.println("Complaints count" +numCountBill1);
		System.out.println("Complaints count 1 " +numCountBill2);
		
		System.out.println("Complaints" +userVec);
		System.out.println("Complaints 1 " +userVec1);
		/**
	     * setContentType - text/html to write String on page.
	     * PrintWriter - This line use to get writer to write on page.
	     * out.println - use to write string. 
	     * 
	     */
		
		String strComplaints = getUserList(userVec,userVec1,numCountBill1,numCountBill2, userid, facId, month,nYear, dataSource);
		System.out.println(strComplaints);
		response.setContentType("text/html;charset=ISO-8859-1");
	    PrintWriter out = response.getWriter();
	    
	    out.write(strComplaints);
	    out.flush();
	    out.close();
		return null;
			}

	private String getUserList(Vector comVec, Vector comVec1,int count, int count1, String userid, String FacilityId, String mon, String year,DataSource dataSource)
	{
		String strValue = "";
		IndvMaster indvMaster= new IndvMaster();
		
		if ((count==0) && (count1==0))
		{
			strValue += "<div class=\"top_panel\">";
			 strValue +="<div class=\"Page_Heading\">";
			 strValue +="<div class=\"Page_Heading_Text\" style=\"width:70%;\"></div></div>";
			 strValue +="<div class=\"Fields_Container\">";
			 strValue +="<div class=\"Fields_Container_Inside\">";                  
			strValue += "<div class=\"Fields_Row_2a\">";
			strValue += "<div class=\"Row_2_Fields_Col_2\" style=\"width: 20%;\" text-align: right;\"> No Bills found...</div>";
			strValue += "<div class=\"Row_2_Fields_Col_2\" style=\"width: 20%;\" text-align: right;\" </div></div>";
			strValue += "</div></div></div>";
		}
		else
		{
		  if (count != 0){
			for(int i=0; i<comVec.size(); i++)
			{
				  
				  int j = i+1;
			    	int numTotal = j%2;			    	
						    	
				 Vector tempVec = (Vector)comVec.elementAt(i);
				 
				 String Serviceid = tempVec.elementAt(0).toString().trim();				 							
				 String SName = tempVec.elementAt(1).toString().trim();
				 String Charges = tempVec.elementAt(2).toString().trim();
				 String Due_Date = tempVec.elementAt(3).toString().trim();
				 String Subscription = tempVec.elementAt(4).toString().trim();
				 //String Cess = tempVec.elementAt(4).toString().trim();
				 strValue +="<div class=\"top_panel\">"; 
				 strValue +="<div class=\"Page_Heading\">";
				 strValue +="<div class=\"Page_Heading_Text\" style=\"width:70%;\">"+SName+"</div>";
						
				 strValue +="<div style=\"float: left;\">";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Cash</a>";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Credit Card</a>";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Cheque</a>";
				 strValue +="</div></div>";
								              
				 strValue +="<div class=\"Fields_Container\">";
				 strValue +="<div class=\"Fields_Container_Inside\">";                  						  				 
				 
		//		 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;\">Charges</div>
		//			 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;">Your Area</div>
		//						<div style="float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;">Total Amount</div>
		//					</div>
				 
				 strValue +="<div class=\"Fields_Row_1\">";
				 float startread=0;
				 float endread=0;
				 if (Subscription.equals("Consumption")){
					 Vector<String> paramVec = new Vector<String>();
						paramVec.add(userid);
						paramVec.add(FacilityId);
						paramVec.add(Serviceid);							
						paramVec.add(mon);
						paramVec.add(year);
						
						Vector billDetailsVec = indvMaster.BilDetailsReading(dataSource,paramVec);			 	 
					 //System.out.println("Bill meter reading details1 "+billDetailsVec);
					 Vector readingDetails = (Vector)billDetailsVec.elementAt(0);
					 //System.out.println("Bill meter reading details2 "+billDetailsVec.elementAt(0).toString().trim());
					 startread = Float.parseFloat(readingDetails.elementAt(2).toString().trim());
					 endread = Float.parseFloat(readingDetails.elementAt(3).toString().trim());}
				 
				 if (Subscription.equals("Consumption")){
				 strValue +="<div style=\"float:left;	width:20%; text-align:left;	margin-left:25px; display:inline; font-weight:bold;\">Start Reading</div>";
				 strValue +="<div style=\"float:left;	width:20%; text-align:left;	margin-left:25px; display:inline; font-weight:bold;\">End Reading</div>";			
				 }
				strValue +="<div style=\"float:left;	width:20%; text-align:left;	margin-left:25px; display:inline; font-weight:bold;\">Due Date</div>";
				 strValue +="<div style=\"float:left;	width:20%; text-align:left;	margin-left:25px; display:inline; font-weight:bold;\">Due Amount</div>";			
				 
				 strValue +="<div style=\"float:left;	width:90%; text-align:left; padding-bottom:5px; \">";
				 	
				 if (Subscription.equals("Consumption")){
				 strValue +="<div style=\"float:left;	width:98%; text-align:left; padding-bottom:5px; \">";
				 strValue +="<div style=\"float:left;   width:20%; text-align:left;	margin-left:30px; display:inline; font-weight:normal;\">"+startread+"</div>";
				 strValue +="<div style=\"float:left;	width:20%; text-align:left;	margin-left:50px; display:inline; font-weight:normal;\">"+endread+"</div>";				 
				 }	 
				 		
				 strValue +="<div style=\"float:left;   width:20%; text-align:left;	margin-left:24px; display:inline; font-weight:normal;\">"+Due_Date+"</div>";
				 strValue +="<div style=\"float:left;	width:14%; text-align:left;	margin-left:40px; display:inline; font-weight:normal;\">"+Charges+"</div>";
				 strValue +="</div>";  	
				strValue += "</div>       </div>              </div></div>";
			}}
			if (count1 != 0){
				strValue +="<div class=\"top_panel\">"; 
				
				strValue += "<div class=\"Page_Heading\">";	
				strValue += "<div class=\"Page_Heading_Text\" style=\"width: 70%;\">Subscriptions</div>";
				strValue +="<div style=\"float: left;\">";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Cash</a>";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Credit Card</a>";
				 strValue +="<a href=\"#\" style=\"text-decoration: none; background-color:#92B4FB; padding:4px 6px; margin-right:2px; font-size: 10px; font-weight: bold; color: rgb(0, 0, 0); cursor:text;\">Cheque</a>";
				 strValue +="</div></div>";
				
			
				strValue += "<div class=\"Fields_Container\">";	
				strValue += "<div class=\"Fields_Container_Inside\">";
				
				 strValue += "<div class=\"Fields_Row_1\">";
				 
				 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;\">Service</div>";
				 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;\">Due Amount</div></div>";
		
				for(int i=0; i<comVec1.size(); i++)
				{
					  
					  int j = i+1;
				    	int numTotal = j%2;			    	
							    	
					 Vector tempVec = (Vector)comVec1.elementAt(i);
					 String Serviceid = tempVec.elementAt(0).toString().trim();				 							
					 String SName = tempVec.elementAt(1).toString().trim();
					 String Charges = tempVec.elementAt(2).toString().trim();
					 String Due_Date = tempVec.elementAt(3).toString().trim();
					 String Subscription = tempVec.elementAt(4).toString().trim();						 													

					 if (Subscription.equals("Consumption")){
						 Vector<String> paramVec = new Vector<String>();
							paramVec.add(userid);
							paramVec.add(FacilityId);
							paramVec.add(Serviceid);							
							paramVec.add(mon);
							paramVec.add(year);
							
							Vector billDetailsVec = indvMaster.BilDetailsReading(dataSource,paramVec);			 	 
						 //System.out.println("Bill meter reading details1 "+billDetailsVec);
						 Vector readingDetails = (Vector)billDetailsVec.elementAt(0);
						 //System.out.println("Bill meter reading details2 "+billDetailsVec.elementAt(0).toString().trim());
						 float startread = Float.parseFloat(readingDetails.elementAt(2).toString().trim());
						 float endread = Float.parseFloat(readingDetails.elementAt(3).toString().trim());
						 strValue +="<div style=\"float:left;	width:13%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;\">Start Reading</div>";
						 strValue +="<div style=\"float:left;	width:13%; text-align:left;	margin-left:55px; display:inline; font-weight:bold;\">End Reading</div></div>";			
								
						 strValue +="<div style=\"float:left;	width:90%; text-align:left; padding-bottom:5px; \">";
						 strValue +="<div style=\"float:left;width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:normal;\">"+startread+"</div>";
						 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:normal;\">"+endread+"</div>";

					 }				 

					 strValue +="<div style=\"float:left;	width:90%; text-align:left; padding-bottom:5px; \">";
					 
					strValue += "<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:normal;\">"+SName+"</div>";								
					 strValue +="<div style=\"float:left;	width:23%; text-align:left;	margin-left:55px; display:inline; font-weight:normal;\">"+Charges+"</div>";
					strValue += "</div></div>";

					
					
				}	
		  					
		  }	}
							strValue += "</div></div>";
		  	return strValue;
	}
	}
	

