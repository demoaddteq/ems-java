/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.mm.struts.entp.action;


import java.io.PrintWriter;
import java.util.Vector;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import javax.sql.DataSource;
import java.io.PrintWriter;

import com.mm.core.master.EntpMaster;
import com.mm.core.master.RootMaster;

/** 
 * MyEclipse Struts
 * Creation date: 08-01-2007
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class GetAllotedCategoryAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception  {
		HttpSession session = request.getSession();
		
		String uId = (request.getParameter("uId")!= null) ? (String)request.getParameter("uId") : (String)session.getAttribute("uId");
		String compId =(String)session.getAttribute("compId");
		Vector allRights =(Vector)session.getAttribute("allRights");
		String adminFlag = allRights.elementAt(18).toString();
		int numCount = Integer.parseInt((request.getParameter("numCount")!=null) ? request.getParameter("numCount").toString().trim() : "0") ;
		int reminder = numCount%2;	
		DataSource dataSource = getDataSource(request, "entp");
		EntpMaster entpMaster = new EntpMaster();
		String catIds = entpMaster.getCoreUserCatId(dataSource, Integer.parseInt(uId));
		////System.out.println("catIds>>>>>>>>>>>>>>"+catIds);
		if(catIds.equals("failure"))
		{
			catIds = "0";
		}
		Vector userCatVec = entpMaster.getUserCategories(dataSource,catIds,0);
		Vector userNotCatVec = entpMaster.getUserCategories(dataSource,catIds,1);
		
		String strCoreUser = getCoreUser(request,compId,uId);
		String strCatuser = getUserCat(userCatVec);
		String strNotCatuser = getNotUserCat(userNotCatVec);
		
		
		String strCategory = getCategoryList(request,strCatuser,strNotCatuser,strCoreUser,reminder);
		
		response.setContentType("text/html;charset=ISO-8859-1");
	    PrintWriter out = response.getWriter(); 
	    out.println(strCategory);
	    out.flush();
		return null;
	}
	private String getCategoryList(HttpServletRequest request ,String strCatuser, String strNotCatuser,String strCoreUser ,int reminder)
	{
		String strValue = "<table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" >"; 
		strValue += "<form  name=\"entpAllotcomplaintForm\" method=\"post\"   action=\"allotcomplaint.do\">"; 
		strValue += "<tr>";
		strValue += " <td width=\"350\" height=\"30\" align=\"right\" ></td>";
		strValue += "<td width=\"42\" height=\"20\"></td>";
		strValue += "<td valign=\"top\"><br></td><td width=\"358\" height=\"20\"><br></td>";
		strValue += "</tr>";
		strValue += " <tr>";
		strValue += " <td width=\"350\" align=\"right\" class=\"bold\">User Name&nbsp;&nbsp;&nbsp;&nbsp;</td>";
		strValue += " <td height=\"30\" colspan=\"2\">"+strCoreUser+"<br></td>";      
		strValue += "</tr>";
		strValue += "<tr>";
		strValue += "<td height=\"30\" align=\"right\" class=\"bold\">Categories&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>";
		strValue += "<td height=\"20\"><br></td>";
		strValue += "<td valign=\"top\"><br></td><td class=\"bold\">&nbsp;&nbsp;&nbsp;Alloted Categories </td>";
		strValue += "</tr>";
		strValue += "<tr>";
		strValue += "<td align=\"right\" >";
		strValue +=  strNotCatuser;
		strValue += "<br></td>";
		strValue += "<td align=\"center\" valign=\"middle\"><input type=\"button\"  name=\"Button\" value=\"&gt;&gt;\" onclick=\"addPermission()\"></input>";
		strValue += "&nbsp;<BR>";
		strValue += "	<BR>";
		strValue += "	<BR>";
		strValue += "<input type=\"button\"  name=\"Submit2\" value=\"&lt;&lt;\" onclick=\"removePermission()\"></input></td>";
		strValue += "<td align=\"left\" valign=\"top\"><br></td><td>";
		strValue += strCatuser;
		strValue += "<br></td>";
		strValue += " </tr>";
		strValue += " <tr>";
		strValue += " <td height=\"30\" align=\"right\"><br></td>";
		strValue += " <td height=\"20\"><br></td>";
		strValue += " <td valign=\"top\"><br></td><td height=\"20\"><br></td>";
		strValue += " </tr>";
		strValue += "  <tr align=\"center\">";
		strValue += " <td colspan=\"4\"><input name=\"Submit\" type=\"submit\"  value=\"Submit\" disabled=\"true\"></input><br></td>";
		strValue += "  </tr>";
		strValue += "  <tr>";
		strValue += " <td height=\"30\" align=\"right\"><br></td>";
		strValue += "  <td height=\"20\"><input type=\"hidden\" name=\"permissions\" value=\"\"><br></td>";
		strValue += "  <td valign=\"top\"><br></td><td height=\"20\"></td>";
		strValue += " </tr>";
		if(reminder==0)
		{
			strValue += "<tr align=\"center\">";
			strValue += "<td height=\"4\" valign=\"center\" colspan=\"5\" class=\"bold\"> </td>";
			strValue += "</tr>";
		}
		strValue += "</form>";
		
		strValue += "</table>";
		return strValue;
	}
	private String getCoreUser(HttpServletRequest request , String compId,String uId)
	{
		RootMaster  rootMaster = new RootMaster();
		String strResult ="<select name=\"cmbUser\" onchange=\"retrieveAllotedCategoryURL('getAllotedCategory.do?uId='+this.value);\">";
		Vector cureUserVec = rootMaster.getUserList(getDataSource(request, "entp"),Integer.parseInt(compId));
		int adminId = Integer.parseInt(uId);
		for(int i=0; i<cureUserVec.size(); i++)
		{
			Vector tempVec =  (Vector)cureUserVec.elementAt(i);
			int userId = Integer.parseInt(tempVec.elementAt(0).toString().trim());
			String uName = tempVec.elementAt(1).toString().trim()+" "+tempVec.elementAt(2).toString().trim();
			if(userId == adminId)
			{
				strResult += "<option value=\""+userId+"\" Selected>" + uName + "</option>";
			}
			else
			{
				strResult += "<option value=\"" + userId+"\">" + uName + "</option>";
			}
			
				
		}
		strResult += "</select>";
		return strResult;
	}
	private String getUserCat(Vector catUserVec)
	{
		
		String strResult ="<select name=\"allotedPermissionList\" size=\"10\" style=\"width=150\">";
		for(int i=0; i<catUserVec.size(); i++)
		{
			Vector tempVec =  (Vector)catUserVec.elementAt(i);
			int catId = Integer.parseInt(tempVec.elementAt(0).toString().trim());
			String vatName = tempVec.elementAt(1).toString().trim();
			strResult += "<option value=\"" + catId+"\">" + vatName + "</option>";
						
		}
		strResult += "</select>";
		return strResult;
	}
	private String getNotUserCat(Vector notCatUserVec)
	{
		String strResult ="<select name=\"permissionList\" size=\"10\" style=\"width=150\">";
		for(int i=0; i<notCatUserVec.size(); i++)
		{
			Vector tempVec =  (Vector)notCatUserVec.elementAt(i);
			int catId = Integer.parseInt(tempVec.elementAt(0).toString().trim());
			String catName = tempVec.elementAt(1).toString().trim();
				strResult += "<option value=\"" + catId+"\">" + catName + "</option>";
					
		}
		strResult += "</select>";
		return strResult;
	}

}