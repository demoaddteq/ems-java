package com.mm.struts.entp.action;

/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */


import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionError;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import com.mm.struts.entp.form.FirstusercreationForm;
import javax.servlet.http.HttpSession;
import com.mm.struts.entp.form.FirstCreationVo;
import javax.sql.DataSource;
import java.util.Vector;
import java.util.StringTokenizer;
import java.text.SimpleDateFormat;
import com.mm.core.master.RootMaster;
import com.mm.core.master.EntpMaster;
import com.mm.core.resource.Constant;
import com.mm.core.resource.MailText;
import com.mm.core.resource.Resource;


/** 
 * MyEclipse Struts
 * Creation date: 06-27-2007 
 * 
 * XDoclet definition:
 * @struts.action path="/firstCreation" name="firstCreationForm" input="/firstcreation.jsp" scope="request" validate="true"
 * @struts.action-forward name="success" path="/login.jsp"
 * @struts.action-forward name="failure" path="/firstcreation.jsp"
 */
public class FirstusercreationAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		RootMaster rootMaster= new RootMaster();
		FirstCreationVo firstCreationVo;
		String companyType ="Advertiser";
		String strResult="";
		String creationDate ="";
		String expiryDate ="";
		String creationTime = "";
	    //String timePart = "";
		Vector<String> companyVec= new Vector<String>();
		DataSource dataSource = getDataSource(request,"entp");
		
		HttpSession session = request.getSession();
		if(session.getAttribute("companyData")!=null)
		{
			firstCreationVo = (FirstCreationVo)session.getAttribute("companyData");
					
		}
		else
		{
			return mapping.findForward("sessionFail");
		}
		FirstusercreationForm firstusercreationForm = (FirstusercreationForm) form;// TODO Auto-generated method stub
//		check userid for registration of a user
		
		String strVerifyResult=rootMaster.checkLoginId(dataSource,firstusercreationForm.getUserID(),firstusercreationForm.getUserEMail());
		if(strVerifyResult.equals("loginId"))
		{
			ActionErrors errors = new ActionErrors();
			errors.add("duplicate", new ActionError("errors.user.duplicate"));
			if(!errors.isEmpty())
			{
				saveErrors(request, errors);
			}
			return mapping.findForward("failure");
			
		}
		
		//end user check
		java.util.Date dt = new java.util.Date();
		SimpleDateFormat sform = new SimpleDateFormat("yyyy-MM-dd, HH:mm:ss,a");
		String completeRemDate = sform.format(dt);
		StringTokenizer sttotal = new StringTokenizer(completeRemDate, ",");
	    creationDate = sttotal.nextToken();
	    creationTime = sttotal.nextToken();
	    sttotal.nextToken();
	    expiryDate=rootMaster.returnFinalDate("Months",3);
	    String tempCountry[] = firstCreationVo.getCompCountry().split("~");
		String compCountry=tempCountry[0];
		String compState = firstCreationVo.getCompanyState();
		String compCity = firstCreationVo.getCompanyCity();
		if(compCountry.equals("-1"))
		{
			//SET COUNTRY ,STATE ,CITY IN DATA BASE AND GENERATE ID FOR THAT AND ADD THESE IDS IN COMPANY MASTER TABLE.
			compCountry=rootMaster.insertCountry(dataSource,firstCreationVo.getTxtCPPrefix(),firstCreationVo.getOthercompCountry());//return country id
			compState=rootMaster.insertState(dataSource,firstCreationVo.getOthercompanyState(),compCountry);
			compCity=rootMaster.insertCity(dataSource,firstCreationVo.getOthercompanyCity(),compState,compCountry);
		}
		else if(compState.equals("-1"))
		{
			//set state .city in data base and add these field in company master table
			compState=rootMaster.insertState(dataSource,firstCreationVo.getOthercompanyState(),compCountry);
			compCity=rootMaster.insertCity(dataSource,firstCreationVo.getOthercompanyCity(),compState,compCountry);
		}
		else if(compCity.equals("-1"))
		{
			//set sity in data base and add that is in company master.
			compCity=rootMaster.insertCity(dataSource,firstCreationVo.getOthercompanyCity(),compState,compCountry);
		}
		else
		{
			//nothing 
		}
		String tempcat="";
		String companyTemplate[] = firstCreationVo.getCompanyTemplate();
		for(int i=0; i<companyTemplate.length;i++)
		{
			String tempCatval = companyTemplate[i];
			if(tempCatval.equals("-1"))
			{
				//set category in category table and add that id in company master table
				//tempCatval=rootMaster.insertCategory(dataSource,firstCreationVo.getOthercompanyTemplate());
			}
			if(i<companyTemplate.length-1)
			  tempcat = tempcat+tempCatval+", ";
			else
				tempcat = tempcat+tempCatval;
		}
		
		String phoneNo = firstCreationVo.getTxtCPPrefix()+"~"+firstCreationVo.getTxtCAreacode()+"~"+firstCreationVo.getTxtCPhone();
		companyVec.add(firstCreationVo.getCompanySName());
		companyVec.add(firstCreationVo.getCompanyName());
		companyVec.add(firstCreationVo.getCompanyAddress1());
		companyVec.add(firstCreationVo.getCompanyAddress2());
		companyVec.add(compCity);
		companyVec.add(compState);
		companyVec.add(compCountry);
		companyVec.add(firstCreationVo.getCompanyPostalCode());
		companyVec.add(firstCreationVo.getCompanyEMail());
		companyVec.add(phoneNo);
		companyVec.add(tempcat);
		companyVec.add("10");
		companyVec.add("0");
		companyVec.add("1");
		companyVec.add(expiryDate);
		companyVec.add("0");
		companyVec.add("1");
		companyVec.add(companyType);
		companyVec.add(firstCreationVo.getCompanySName());
		companyVec.add("2");
		companyVec.add("1");
		companyVec.add(creationDate);
		companyVec.add(expiryDate);
		companyVec.add("0");
		companyVec.add("1");
		
		strResult=rootMaster.insertCompanyDetail(dataSource,companyVec);
		if(strResult.equalsIgnoreCase("success"))
		{
			
			//add user rights by default 1 for first user
			
			
			Vector companyDetailVec=rootMaster.getCompanyDetail(dataSource,firstCreationVo.getCompanySName());
			Vector<String>userVec= new Vector<String>();
			String tempuserCountry[] = firstusercreationForm.getCountry().split("~");
			String userCountry=tempuserCountry[0];
			String userState = firstusercreationForm.getState();
			String userCity = firstusercreationForm.getCity();
			if(userCountry.equals("-1"))
			{
				//SET COUNTRY ,STATE ,CITY IN DATA BASE AND GENERATE ID FOR THAT AND ADD THESE IDS IN COMPANY MASTER TABLE.
				userCountry=rootMaster.insertCountry(dataSource,firstusercreationForm.getTxtPPrefix(),firstusercreationForm.getOthercompCountry());//return country id
				userState=rootMaster.insertState(dataSource,firstusercreationForm.getOthercompanyState(),userCountry);
				userCity=rootMaster.insertCity(dataSource,firstusercreationForm.getOthercompanyCity(),userState,userCountry);
			}
			else if(userState.equals("-1"))
			{
				//set state .city in data base and add these field in company master table
				userState=rootMaster.insertState(dataSource,firstusercreationForm.getOthercompanyState(),userCountry);
				userCity=rootMaster.insertCity(dataSource,firstusercreationForm.getOthercompanyCity(),userState,userCountry);
			}
			else if(userCity.equals("-1"))
			{
				//set sity in data base and add that is in company master.
				userCity=rootMaster.insertCity(dataSource,firstusercreationForm.getOthercompanyCity(),userState,userCountry);
			}
			else
			{
				//nothing 
			}
			
			String userphoneNo ="";
			if(firstusercreationForm.getTxtAreacode().length()>0 || firstusercreationForm.getTxtPhone().length()>0)
			{
				userphoneNo=firstusercreationForm.getTxtPPrefix()+"~"+firstusercreationForm.getTxtAreacode()+"~"+firstusercreationForm.getTxtPhone();
			}
			String userMobile = firstusercreationForm.getTxtPrefix()+"~"+firstusercreationForm.getTxtMobile();
			userVec.add(companyDetailVec.elementAt(0).toString());
			userVec.add("1");
			userVec.add(firstusercreationForm.getUserID());
			userVec.add(firstusercreationForm.getUserPassword());
			userVec.add(firstusercreationForm.getUserFirstName());
			userVec.add(firstusercreationForm.getUserLastName());
			userVec.add(firstusercreationForm.getUserEMail());
			userVec.add(userphoneNo);
			userVec.add(userMobile);
			userVec.add(firstusercreationForm.getUserAddress());
			userVec.add(userCountry);
			userVec.add(userState);
			userVec.add(userCity);
			userVec.add(firstusercreationForm.getUserPostalCode());
			userVec.add("nophoto.jpg");
			userVec.add("IN");
			userVec.add(creationDate);
			userVec.add(creationTime);
			userVec.add("0000-00-00");
			userVec.add("00:00:00");
			userVec.add("0");
			userVec.add("20");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("0");
			userVec.add("Male");
			
			strResult=rootMaster.insertUserInfo(dataSource,userVec);
			
			Vector userFinalData = rootMaster.getUserInfo(dataSource,firstusercreationForm.getUserID());
			//mail transfer code here.
			Resource resr = new Resource();
			MailText mt = new MailText();
			String strMailText = "";
			if(companyType.equalsIgnoreCase("Advertiser"))
			{
				strMailText = mt.getETextForAdvtReg(firstusercreationForm.getUserID(), firstusercreationForm.getUserPassword(), firstusercreationForm.getUserFirstName(), firstusercreationForm.getUserLastName());
			}
			else
			{
				strMailText = mt.getETextForEntpReg(firstusercreationForm.getUserID(), firstusercreationForm.getUserPassword(), firstusercreationForm.getUserFirstName(), firstusercreationForm.getUserLastName());
			}
			String strEmailStatus = resr.sendMail(strMailText, Constant.Email_Sender, firstusercreationForm.getUserEMail(), Constant.Email_Title_For_UCreation);
			//System.out.println("str Email Status "+strEmailStatus);
			//System.out.println("userFinalData "+userFinalData);
			String advtl_id = userFinalData.elementAt(0).toString().trim();
			String advt_id = userFinalData.elementAt(1).toString().trim();
			
			EntpMaster entpMaster = new EntpMaster();
			String complaint_id = (String)session.getAttribute("numCopmId");
			//System.out.println("complaint_id in action >>"+complaint_id);
			strResult = entpMaster.updateComplaint(dataSource, advt_id, advtl_id, complaint_id.trim());
			
		}
		session.removeAttribute("companyData");
		
		session.setAttribute("userResult", strResult);
		return mapping.findForward(strResult);
	}
}