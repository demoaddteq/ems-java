
/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.mm.struts.entp.action;


import java.io.PrintWriter;
import java.util.Vector;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.mm.core.master.*;

/** 
 * MyEclipse Struts
 * Creation date: 07-03-2007
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class CommentsAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception 
	{
		HttpSession session = request.getSession();
		
		String numCount = (String)session.getAttribute("numCount");
		int count = Integer.parseInt(numCount);
		int remander = count%2;
		////System.out.println("remander..........."+remander);
		
		String uId =(String)session.getAttribute("uId");		
		Vector allRights =(Vector)session.getAttribute("allRights");
		String adminFlag = allRights.elementAt(18).toString();
		
		String strShortBy = (request.getParameter("sby")!=null) ? request.getParameter("sby") : "commentdate";
		String strSOrder = "";
		
		String strCommentDate = "asc";
		String strCommentBy = "asc";
		String strCommentText = "asc";
		
		if(request.getParameter("sby")!=null)
		{
			
			
			if(request.getParameter("camdate")!=null)
			{
				if(request.getParameter("camdate").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strCommentDate = "desc";
				}
				else if (request.getParameter("camdate").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strCommentDate = "asc";
				}
			}
			
			if(request.getParameter("commentby")!=null)
			{
				if(request.getParameter("commentby").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strCommentBy = "desc";
				}
				else if (request.getParameter("commentby").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strCommentBy = "asc";
				}
			}
			
			if(request.getParameter("camtext")!=null)
			{
				if(request.getParameter("camtext").trim().equalsIgnoreCase("asc"))
				{
					strSOrder = "desc";
					strCommentText = "desc";
				}
				else if (request.getParameter("camtext").trim().equalsIgnoreCase("desc"))
				{
					strSOrder = "asc";
					strCommentText = "asc";
				}
			}
			
			
		}
		String strFShortBy = strShortBy+" "+strSOrder;
		int minVal = (request.getParameter("numMin")!=null) ? Integer.parseInt(request.getParameter("numMin")) : 0;
		int maxVal = 10;
		EntpMaster am = new EntpMaster();
		RootMaster ob = new RootMaster();
		
		Vector<String> paramVec1 = new Vector<String>();
		paramVec1.add(uId);//Core user id 
		paramVec1.add(adminFlag);// adminFlag 
		int totalRow = am.getNewCommentCount(getDataSource(request, "entp"), paramVec1);
	
		//System.out.println("totalRow.................."+totalRow);
		//int totalRow=500;
		String strPageHtml = getPages(minVal, maxVal, totalRow,numCount);
		
		Vector<String> paramVec = new Vector<String>();		
		paramVec.add(String.valueOf(minVal));
		paramVec.add(String.valueOf(maxVal));
		paramVec.add(strFShortBy);
		paramVec.add(uId);//Core user id 
		paramVec.add(adminFlag);//Core adminFlag 
		Vector userVec = am.getNewCommentsList(getDataSource(request, "entp"), paramVec);
		
		Vector<String> userName = new Vector<String>();		
		for(int i=0; i<userVec.size(); i++)
		{
			 Vector tempVec1 = (Vector)userVec.elementAt(i);
			 		
			 int userId = Integer.parseInt(tempVec1.elementAt(1).toString().trim());
			 Vector userNameVec = ob.getUserInfo(getDataSource(request, "entp"), userId);			 
			 String strUserN = userNameVec.elementAt(4).toString()+" "+userNameVec.elementAt(5).toString();
			 userName.add(strUserN);
		}
		
		String strUsers = getUserList(strCommentBy, strCommentText,strCommentDate, minVal, strPageHtml, userVec, userName, remander);
		//System.out.println("Users "+strUsers);
		/**
	     * setContentType - text/html to write String on page.
	     * PrintWriter - This line use to get writer to write on page.
	     * out.println - use to write string. 
	     * 
	     */
		response.setContentType("text/html;charset=ISO-8859-1");
	    PrintWriter out = response.getWriter();
	    out.println(strUsers);
	    out.flush();
		return null;
	}
	
	private String getUserList(String strCommentBy, String strCommentText,String strCommentDate, int minVal, String strPageHtml, Vector userVec, Vector userName, int remander)
	{
		
		
		String strValue = "<table width=\"100%\"   cellpadding=\"0\" cellspacing=\"0\" >";
		if(userVec.size()==0)
		{
			strValue += "<tr align=\"center\">";
			strValue += "<td height=\"400\" valign=\"center\" colspan=\"4\" class=\"bold\"> No Data Found</td>";
			strValue += "</tr>";
		}
		else
		{
		strValue += "<tr >";
		strValue += "<td colspan=\"4\" align=\"right\" >Page Number  "+strPageHtml+"</td>";		
		strValue += "</tr>";
		
		strValue += "<tr>";
        strValue += "<td width=\"100%\">";
	    strValue += "<table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" >"; 
	    strValue += "<tr>";	
	    strValue += "<td height=\"5\" colspan=\"4\" align=\"right\"><hr color=\"#ff722b\"></td>";	
	    strValue += "</tr>";
	    //strComIdOrder
	    //strCTitelOrder
	    //strDateOrder
	    //asc, desc
	    String strCommDateSymbol = (strCommentDate.trim().equalsIgnoreCase("asc")) ? "<img style=\"cursor:hand\" src=\"../images/downarrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=commentdate&numMin="+ minVal+"&camdate="+strCommentDate+"');\">" : "<img style=\"cursor:hand\" src=\"../images/uparrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=commentdate&numMin="+ minVal+"&camdate="+strCommentDate+"');\">";
	    String strCommtBySymbol = (strCommentBy.trim().equalsIgnoreCase("asc")) ? "<img style=\"cursor:hand\" src=\"../images/downarrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=userid&numMin="+ minVal+"&commentby="+strCommentBy+"');\">" : "<img style=\"cursor:hand\" src=\"../images/uparrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=userid&numMin="+ minVal+"&commentby="+strCommentBy+"');\">";
	    String strcommTextSymbol = (strCommentText.trim().equalsIgnoreCase("asc")) ? "<img style=\"cursor:hand\" src=\"../images/downarrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=commenttext&numMin="+ minVal+"&camtext="+strCommentText+"');\">" : "<img style=\"cursor:hand\" src=\"../images/uparrow.gif\" onClick=\"retrieveEntpCommentslistURL('comments.do?sby=commenttext&numMin="+ minVal+"&camtext="+strCommentText+"');\">";
	    
	    strValue += "<tr height=\"20\" >";	
	    strValue += "<th class=\"bold\">&nbsp;S. No.</th>";
	    strValue += "<th class=\"bold\">Date&nbsp;"+strCommDateSymbol+"</th>";	    
	    strValue += "<th class=\"bold\">Commnet By&nbsp;"+strCommtBySymbol+"</th>";	
	    strValue += "<th class=\"bold\">Commnet Text&nbsp;"+strcommTextSymbol+"</th>";
	   
	    strValue += "</tr>";	
	    strValue += "<tr>";	
	    strValue += "<td height=\"5\" colspan=\"4\" align=\"right\"><hr color=\"#ff722b\"></td>";	
	    strValue += "</tr>";
		
		
		
		
		       
        
		
			for(int i=0; i<userVec.size(); i++)
			{
				int j = i+1;
		    	int numTotal = j%2;
		    	String strColor = (numTotal==0) ? "#E6E6E6" : "#F0F0F0";
		    	String strImg = (numTotal==0) ? "detail_gray.gif" : "detail_white.gif";
				 String strCommBy = userName.elementAt(i).toString().trim();
				 
				 Vector tempVec = (Vector)userVec.elementAt(i);				 
				 int numCid = Integer.parseInt(tempVec.elementAt(0).toString().trim());				
				 
				 String strCommDt = tempVec.elementAt(4).toString().trim();
				
//				 	for check length of Complaint text
				 String strText = "";  
				 String strFMsg = "";
				 
					String strMessage =  tempVec.elementAt(2).toString().trim();
					////System.out.println("complaintMessage........."+strMessage.length());
					////System.out.println("complaintMessage........."+strMessage);
					int numChar = (strMessage.length() > 40) ? 40 : strMessage.length();  
					for(int k=0; k<numChar; k++)
					{ 
						
							   strFMsg = strFMsg+strMessage.charAt(k);
							   
							
					}
					if(strFMsg.lastIndexOf(strFMsg)!=-1)
					{
						 strText= strFMsg;
						//System.out.println("...strFMsgTeam......"+strFMsg.lastIndexOf(strFMsg));
						
			         
			        }else{
			        	strText= strFMsg.substring(0, strFMsg.lastIndexOf(" "));
			        	//System.out.println("...strText......");
			        }	
				
				 
				 strValue += "<tr height=\"25\" align=\"center\" bgcolor=\""+strColor+"\">";
				strValue += "<td width=\"10%\" > "+j+" </td>"; 
				strValue += "<td width=\"15%\" > "+strCommDt+" </td>"; 
				strValue += "<td width=\"20%\" height=\"25\" nowrap > "+strCommBy+" </td>";
				strValue += "<td width=\"50%\" height=\"25\" nowrap > "+strText+"... <a href=\"getComment.do?commentId="+numCid+"\" class=\"bold\" >More</a></td>";
								
				strValue += "</tr>";
				
				   
			       
				
			}
			strValue += "</table >";
			strValue += "</td >";
			strValue += "</tr >";
			strValue += "<tr>";	
		    strValue += "<td height=\"5\" colspan=\"4\" align=\"right\"><hr color=\"#ff722b\"></td>";	
		    strValue += "</tr>";
			strValue += "<tr >";
			strValue += "<td colspan=\"4\"  align=\"right\" >Page Number  "+strPageHtml+"</td>";		
			strValue += "</tr>";
		}
		if(remander==0)
		{
			strValue += "<tr style=\"display:none\" align=\"center\">";
			strValue += "<td height=\"50\" colspan=\"4\"></td>";
			strValue += "</tr>";
		}
			strValue += "</table>";
		
		return strValue;
	}
	
	private String getPages(int minVal, int maxVal, int numSize,String numCount)
	{
		String strResult ="<select name=\"paging\" onchange=\"retrieveEntpCommentslistURL('comments.do?count="+numCount+"&'+this.value);\">";
		int numMin = 0;
		int numPage = 1;
		for(int i=0; i<numSize; i=i+maxVal)
		{
			numMin = i;
			
			if(minVal == numMin)
			{
				strResult += "<option value=\"numMin=" + numMin+"\" Selected>Page" + numPage + "</option>";
			}
			else
			{
				strResult += "<option value=\"numMin=" + numMin+"\">Page" + numPage + "</option>";
			}
				numPage++;
		}
		strResult += "</select>";
		return strResult;
	}
}	