/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */

package com.mm.struts.entp.action;

import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.StringTokenizer;
import java.util.TimeZone;
import java.util.Vector;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.mm.core.master.EntpMaster;
import com.mm.core.master.RootMaster;
import java.util.Date;

/** 
 * MyEclipse Struts
 * Creation date: 08-20-2007
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class MisReportAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception 
	{
		
		java.util.Date dt = new java.util.Date();
		SimpleDateFormat sform = new SimpleDateFormat("yyyy-MM-dd");
		String toDate = sform.format(dt);
		
		Calendar cal = Calendar.getInstance(TimeZone.getDefault());
		cal.add(Calendar.MONTH, -1);
		String DATE_FORMAT = "yyyy-MM-dd";
        java.text.SimpleDateFormat sdf = new java.text.SimpleDateFormat(DATE_FORMAT);
        sdf.setTimeZone(TimeZone.getDefault());
		String fromDate = sdf.format(cal.getTime()).toString();
		
		//System.out.println("toDate>>>>>>>>>>>>>>>"+toDate);
		//System.out.println("FromDate>>>>>>>>>>>>>>>"+fromDate);
		
		
		
		int numTempCount = (request.getParameter("numCount") != null) ? Integer.parseInt(request.getParameter("numCount").trim()) : 0;
		int field1 = (request.getParameter("field1")!=null) ? Integer.parseInt(request.getParameter("field1").trim()) : 0;
		
		int field2 = (request.getParameter("field2")!=null) ? Integer.parseInt(request.getParameter("field2").trim()) : 0;
		int field3 = (request.getParameter("field3")!=null) ? Integer.parseInt(request.getParameter("field3").trim()) : 0;
		
		String date1 = (request.getParameter("date1") != null) ? request.getParameter("date1") :  fromDate;
		String date2 = (request.getParameter("date2") != null) ? request.getParameter("date2") :  toDate;	
		
		
		String keyArr[] = {"Received", "Attended", "Closed - Resloved", "Closed - UnResloved", "Closed - Rejected", "Managerwise"};
		String SubkeyArr[][] = {
				{"Categorywise","Companywise","Statewise","Citywise"},
				{"Categorywise","Companywise","Statewise","Citywise","Company wise","Manager wise"},
				{"Categorywise","Companywise","Statewise","Citywise","Company wise","Manager wise"},
				{"Categorywise","Companywise","Statewise","Citywise","Company wise","Manager wise"},
				{"Categorywise","Companywise","Statewise","Citywise","Manager wise"},
				{"Received","Attended","Closed -Resolved","Closed - Unresolved","Closed - Rejected","Time taken"}
			   };
		String duration[] = {"Daily", "Weekly", "Monthly"};
		
		String strKey = getKey(field1, field2, field3,numTempCount,keyArr);
		String strSubKey = getSubKey(field1, field2, field3,numTempCount,SubkeyArr);
		String strDuration = getDuration(field1, field2, field3,numTempCount,duration);
		
		
		String strTabresult = getTabresult(field1, field2, field3, keyArr[field1], SubkeyArr[field1][field2], duration[field3],date1,date2);
		
		String strresult = getresult(request,field1, field2, field3,date1,date2);
		
		String strTbl = getTableRow(strKey, strSubKey, strDuration,strTabresult,strresult, numTempCount,field1, field2, field3);
	    response.setContentType("text/html;charset=ISO-8859-1");
	    PrintWriter out = response.getWriter();
	    out.println(strTbl);
	    out.flush();
		return null;
	}
	private String getTableRow(String strKey, String strSubKey, String strDuration,String strTabresult,String strresult, int numTempCount,int field1,int field2,int field3)
	{
		String strResult="<table width=\"100%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\">";
			
		strResult+="<tr>";
		strResult+="<td  align=\"left\" >";
		
		//strResult+="<form id=\"misReport\" name=\"misReport\" method=\"post\" action=\"getMisreport.do\">";
		strResult+="<table width=\"100%\"  border=\"0\" cellpadding=\"0\" cellspacing=\"0\" bgcolor=\"#FF9C6A\">";
		strResult+="<tr align=\"center\" valign=\"middle\">";
		strResult+="<td width=\"19%\" valign=\"top\" rowspan=\"2\" align=\"center\" class=\"bold\">Select Criteria: </td>";
		strResult+="<td width=\"20%\" align=\"center\" class=\"bold\">Queries</td>";
		strResult+="<td width=\"27%\" align=\"center\" class=\"bold\">&nbsp;&nbsp;Criteria</td>";
		strResult+="<td width=\"23%\" align=\"center\" class=\"bold\">&nbsp;</td>";
		strResult+="<td width=\"11%\" align=\"center\">&nbsp;</td>";
		strResult+="</tr>";
		strResult+="<tr align=\"center\" valign=\"middle\">";
		strResult+="<td >";
		strResult+=strKey;
		strResult+="</td>";
		strResult+=" <td >";
		strResult+=strSubKey;
		strResult+="</td>";
		strResult+="<td >";
		strResult+="&nbsp;";
		strResult+="</td>";
		strResult+="<td >&nbsp;</td>";
		strResult+="</tr>";
		
		//duration
		strResult+="<tr align=\"center\" valign=\"middle\">";
		strResult+="<td  valign=\"top\" rowspan=\"2\" align=\"center\" class=\"bold\">Select Duration: </td>";
		strResult+="<td align=\"center\" class=\"bold\">Duration</td>";
		strResult+="<td align=\"center\" class=\"bold\">From</td>";
		strResult+="<td align=\"center\" class=\"bold\">To</td>";
		strResult+="<td align=\"center\">&nbsp;</td>";
		strResult+="</tr>";
		strResult+="<tr align=\"center\" valign=\"middle\">";
		strResult+="<td >";
		strResult+=strDuration;
		strResult+="</td>";
		strResult+=" <td >";
		//strResult+="&nbsp;";
		strResult+="<input type=\"text\" name =\"date1\"  readonly=\"true\"></input>&nbsp;&nbsp;<a href=\"javascript:void(window.open('../Calendar_core.jsp?formName=misReport&fieldName=date1', '', 'width=265,height=340,top=200,left=200,status=yes'))\"><img src=\"../images/calendar.gif\" width=\"21\" height=\"21\" hspace=\"0\" vspace=\"0\" border=\"0\" align=\"absbottom\" title=\"Click here to choose a Date from calendar\"></img></a>";
		strResult+="</td>";
		strResult+="<td >";
		//strResult+="&nbsp;";
		strResult+="<input type=\"text\" name =\"date2\"  readonly=\"true\"></input>&nbsp;&nbsp;<a href=\"javascript:void(window.open('../Calendar_core.jsp?formName=misReport&fieldName=date2', '', 'width=265,height=340,top=200,left=200,status=yes'))\"><img src=\"../images/calendar.gif\" width=\"21\" height=\"21\" hspace=\"0\" vspace=\"0\" border=\"0\" align=\"absbottom\" title=\"Click here to choose a Date from calendar\"></img></a>";
		strResult+="</td>";
		strResult+="<td ><input name=\"Submit\" type=\"submit\"  value=\"Search\" /></td>";
		strResult+="</tr>";
		//end duration
		
		
		strResult+="</table>";
		//strResult+="</form>";
		strResult+="</td>";
		strResult+="</tr>";
		
		
		
		strResult+="<tr  height=\"30\">";
		strResult+="<td align=\"left\" >"+strTabresult+"</td>";
		strResult+="</tr>";
			
		strResult+="<tr>";
		strResult+="<td align=\"right\" ></td>";
		strResult+="</tr>";
		
		strResult+="<tr>";
		strResult+="<td width=\"50%\">";
		strResult+="<table width=\"100%\" align=\"left\" cellpadding=\"0\" cellspacing=\"0\">";
		//set result for the criteria.
		
			strResult+="<tr>";
				strResult+="<td width=\"100%\" align=\"center\" >"+strresult+"</td>";
				
			strResult+="</tr>";
			
				
				
			numTempCount = numTempCount+1;
			int numtotal = numTempCount%2; 
			if(numtotal !=0)
			{
				strResult+="<tr height=\"20\" style=\"display:none\">";
					strResult+="<td align=\"right\" >&nbsp;</td>";
				strResult+="</tr>";
			}
		strResult+="</table>";
		strResult+="</td>";
		strResult+="</tr>";
		strResult+="<tr>";
		strResult+="<td align=\"right\" ></td>";
		strResult+="</tr>";
		strResult+="</table>";
		
		
		return strResult;
	}
	private String getKey(int field1, int field2, int field3,int numTempCount,String[] keyArr)
	{
		
		String strResult ="<select name=\"key\"  tabindex=\"1\" onchange=\"retrieveMisReport('getMisreport.do?field2=0&field3="+field3+"&numCount="+numTempCount+"&field1='+this.value);\">";	
		for(int i=0; i<keyArr.length; i++)
			{
				if(i == field1)
				{
					strResult += "<option value=\""+i+"\" Selected>" + keyArr[i] + "</option>";
					
				}
				else
				{
					strResult += "<option value=\""+i+"\">" + keyArr[i] + "</option>";
					
				}
				
			}
		strResult+="</select>";
		return strResult;
	}
	
	private String getSubKey(int field1, int field2, int field3,int numTempCount,String[][] SubkeyArr)
	{
		String strResult ="<select name=\"subkey\"  tabindex=\"2\" onchange=\"retrieveMisReport('getMisreport.do?field1="+field1+"&field3="+field3+"&numCount="+numTempCount+"&field2='+this.value);\">";
		
		
		
		for(int i=0; i<SubkeyArr[field1].length; i++)
			{
				if(i == field2)
				{
					strResult += "<option value=\""+i+"\" Selected>" + SubkeyArr[field1][i] + "</option>";
					
				}
				else
				{
					strResult += "<option value=\""+i+"\">" + SubkeyArr[field1][i] + "</option>";
					
				}
				
			}
		strResult+="</select>";
		return strResult;
	}
	
	private String getDuration(int field1, int field2, int field3,int numTempCount,String[] duration)
	{
		String strResult ="<select name=\"duration\"  tabindex=\"3\" onchange=\"retrieveMisReport('getMisreport.do?field1="+field1+"&field2="+field2+"&numCount="+numTempCount+"&field3='+this.value);\">";
		for(int i=0; i<duration.length; i++)
			{
				if(i == field3)
				{
					strResult += "<option value=\""+i+"\" Selected>" + duration[i] + "</option>";
				}
				else
				{
					strResult += "<option value=\""+i+"\">" + duration[i] + "</option>";
				}
			}
		
		strResult+="</select>";
		return strResult;
	}
	
	private String getTabresult(int field1, int field2, int field3,String complaint, String criteria, String duration,String date1, String date2)
	{
		String strResult="<table width=\"100%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" valign=\"top\">";
		strResult+="<tr>";
		strResult+="<td  align=\"left\" class=\"bold\">&nbsp;Search Criteria:&nbsp;<span class=\"bold\"> Query Status :</span><span class=\"bold\">"+complaint+"</span>&nbsp;and&nbsp;<span class=\"bold\">criteria :</span><span class=\"bold\">"+criteria+"</span>&nbsp;and&nbsp;<span class=\"bold\">Duration :</span><span class=\"bold\">"+date1+" to "+date2+"</span></td>";
		strResult+="</tr>";
		
		strResult+="</table>";
		return strResult;
	}
	
	private String getresult(HttpServletRequest request,int field1, int field2, int field3,String date1,String date2)
	{
		EntpMaster entpMaster = new EntpMaster();
		Vector<String> dataVec = new Vector<String>();
		dataVec.add(String.valueOf(field1));
		dataVec.add(String.valueOf(field2));
		dataVec.add(String.valueOf(field3));
		dataVec.add(date1);
		dataVec.add(date2);
		
		Vector resultVec = entpMaster.getMisReport(getDataSource(request,"entp"), dataVec);
		String strResult = getFinalResult(resultVec,field1,field2,field3);
		return strResult;
	}
	
	private String getFinalResult(Vector resultVec,int field1, int field2, int field3)
	{
		String strResult="<table width=\"100%\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" valign=\"top\">";
		String head1="Category",head2="Company Name";
		String strWidth = "20%";
		String strhead1Width = "20%";
		String strhead2Width = "30%";
		String strpalceWidth = "15%";
		String strColspan = "4";
		String strPlace1="State",strPalce2="City";
		if(field1 !=5)
		{
			if(field2==1)
			{
				head1="Company Name";
				head2="Category";
				strhead1Width = "30%";
				strhead2Width = "20%";
				
			}
			else if(field2==2)
			{
				strWidth = "10%";
				strhead1Width = "15%";
				strhead2Width = "25%";
				
			}
			else if(field2==3)
			{
				strWidth = "10%";
				strhead1Width = "15%";
				strhead2Width = "25%";
				strPlace1="City";
				strPalce2="State";
			}
			else if(field2==4)
			{
				head1="Company Name";
				head2="Category";
				strhead1Width = "30%";
				strhead2Width = "20%";
			}
			else if(field2==5)
			{
				head1="Company Name";
				head2="Category";
				strhead1Width = "30%";
				strhead2Width = "20%";
			}
		}
		else
		{
			strWidth = "10%";
			strhead1Width = "15%";
			strhead2Width = "25%";
			strPlace1="Manger Name";
			strPalce2="State";
		}
		
		
		
		if(resultVec.size()>0)
		{
			strResult+="<tr>";
			strResult+="<td>";		
			strResult+="<table width=\"100%\"   border=\"1\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" valign=\"top\" bordercolor=\"#999999\">";
			strResult+="<tr bgcolor=\"#999999\">";
			strResult+="<td class=\"bold\" align=\"center\" width=\"10%\">S No.</td>";
			if(field2==2 || field2==3 || field1==5)
			{
				strColspan = "6";
				strResult+="<td class=\"bold\" align=\"center\" width=\""+strpalceWidth+"\">"+strPlace1+"</td>";
				strResult+="<td class=\"bold\" align=\"center\" width=\""+strpalceWidth+"\">"+strPalce2+"</td>";
				
			}
			strResult+="<td class=\"bold\" align=\"center\" width=\""+strhead1Width+"\">"+head1+"</td>";
			strResult+="<td class=\"bold\" align=\"center\" width=\""+strhead2Width+"\">"+head2+"</td>";
			strResult+="<td class=\"bold\" align=\"center\" width=\""+strWidth+"\">Date</td>";
			strResult+="<td class=\"bold\" align=\"center\" width=\""+strWidth+"\">No. Of Queries</td>";
			strResult+="</tr>";
			String tempCat = "";
			String tempcat2 ="";
			String strDate = "";
			int total = 0;
			int grantTotal = 0;
			int cattotal =0;
			long datecount = 0;
			String firstDate = "";
			String lastDate = "";
			
			for(int i = 0; i<resultVec.size();i++)
			{
				double diff = 0d;
				Vector tempVec = (Vector)resultVec.elementAt(i);
							
				String tempField = "&nbsp;";
				String tempPlace1 = "&nbsp;";
				String tempPlace2 = "&nbsp;";
				
				
				if(field1 !=5)
				{
					if(field2==0 || field2==1)
					{
						if(!tempCat.equals(tempVec.elementAt(0).toString().trim()))
						{
							firstDate = tempVec.elementAt(2).toString().trim();
							tempField = tempVec.elementAt(0).toString().trim();
						}
					}
					else
					{
						tempField = tempVec.elementAt(0).toString().trim();
						
						if(!tempCat.equals(tempVec.elementAt(4).toString().trim()))
						{
							firstDate = tempVec.elementAt(2).toString().trim();
							tempPlace1 = tempVec.elementAt(4).toString().trim();
							
						}
						if(!tempcat2.equals(tempVec.elementAt(5).toString().trim()))
						{
							tempPlace2 = tempVec.elementAt(5).toString().trim();
							
						}
					}
					
					
					strResult+="<tr>";
					strResult+="<td  align=\"center\" >"+(i+1)+"</td>";
					if(field2==2 || field2==3 )
					{
										
						strResult+="<td  align=\"center\" >"+tempPlace1+"</td>";
						strResult+="<td  align=\"center\" >"+tempPlace2+"</td>";
					}
					strResult+="<td  align=\"center\" >"+tempField+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(1).toString().trim()+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(2).toString().trim()+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(3).toString().trim()+"</td>";
					
					
					strResult+="</tr>";
					total +=Integer.parseInt(tempVec.elementAt(3).toString().trim());
					String tcat ="";
					String tdate = "";
					if(field2==0 || field2==1 )
					{
						tempCat = tempVec.elementAt(0).toString().trim();
					}
					else
					{
						tempCat = tempVec.elementAt(4).toString().trim();
						tempcat2 = tempVec.elementAt(5).toString().trim();
					}
					strDate = tempVec.elementAt(2).toString().trim();
					if(i< resultVec.size()-1)
					{
						if(field2==0 || field2==1  )
						{
							tcat = ((Vector)resultVec.elementAt(i+1)).elementAt(0).toString().trim();
						}
						else
						{
							tcat = ((Vector)resultVec.elementAt(i+1)).elementAt(4).toString().trim();
						}
						tdate = ((Vector)resultVec.elementAt(i+1)).elementAt(2).toString().trim();
					}
					if(!((tcat.equals(tempCat)) && (tdate.equals(strDate))))
					{
						strResult+="<tr bgcolor=\"#CEFFFF\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Sub Total= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+total+"</td>";
						strResult+="</tr>";
						grantTotal += total;
						cattotal +=total;
						
						total=0;
									
					}
					if(!tcat.equals(tempCat))
					{
						lastDate = tempVec.elementAt(2).toString().trim();
						diff = (double)dateDiff(firstDate, lastDate);
						strResult+="<tr bgcolor=\"#CEFFCE\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Total -"+tempCat+"= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+cattotal+"</td>";
						strResult+="</tr>";
						
						strResult+="<tr bgcolor=\"#FFCF9C\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Average Total -"+tempCat+"= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+cattotal/diff+"</td>";
						strResult+="</tr>";
						datecount =0;
						cattotal =0;
					}
				}
				else
				{
						tempField = tempVec.elementAt(0).toString().trim();
						
						if(!tempCat.equals(tempVec.elementAt(4).toString().trim()))
						{
							firstDate = tempVec.elementAt(2).toString().trim();
							tempPlace1 = tempVec.elementAt(4).toString().trim();
							
						}
						if(!tempcat2.equals(tempVec.elementAt(5).toString().trim()))
						{
							tempPlace2 = tempVec.elementAt(5).toString().trim();
							
						}
					
					
					
					strResult+="<tr>";
					strResult+="<td  align=\"center\" >"+(i+1)+"</td>";
					
										
						strResult+="<td  align=\"center\" >"+tempPlace1+"</td>";
						strResult+="<td  align=\"center\" >"+tempPlace2+"</td>";
					
					strResult+="<td  align=\"center\" >"+tempField+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(1).toString().trim()+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(2).toString().trim()+"</td>";
					strResult+="<td  align=\"center\" >"+tempVec.elementAt(3).toString().trim()+"</td>";
					
					
					strResult+="</tr>";
					total +=Integer.parseInt(tempVec.elementAt(3).toString().trim());
					String tcat ="";
					String tdate = "";
					
					
					
					
						tempCat = tempVec.elementAt(4).toString().trim();
						tempcat2 = tempVec.elementAt(5).toString().trim();
					
					strDate = tempVec.elementAt(2).toString().trim();
					if(i< resultVec.size()-1)
					{
						
						tcat = ((Vector)resultVec.elementAt(i+1)).elementAt(4).toString().trim();
						
						tdate = ((Vector)resultVec.elementAt(i+1)).elementAt(2).toString().trim();
					}
					if(!((tcat.equals(tempCat)) && (tdate.equals(strDate))))
					{
						strResult+="<tr bgcolor=\"#CEFFFF\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Sub Total= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+total+"</td>";
						strResult+="</tr>";
						grantTotal += total;
						cattotal +=total;
						
						total=0;
									
					}
					if(!tcat.equals(tempCat))
					{
						lastDate = tempVec.elementAt(2).toString().trim();
						diff = dateDiff(firstDate, lastDate);
						strResult+="<tr bgcolor=\"#CEFFCE\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Total -"+tempCat+"= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+cattotal+"</td>";
						strResult+="</tr>";
						
						strResult+="<tr bgcolor=\"#FFCF9C\">";
						strResult+="<td class=\"bold\" colspan=\""+strColspan+"\" align=\"right\">Average Total -"+tempCat+"= </td>";
						strResult+=" <td class=\"bold\" align=\"center\">"+cattotal/diff+"</td>";
						strResult+="</tr>";
						datecount =0;
						cattotal =0;
					}
				}
					
				
			}
			
			
			
			
			strResult+="</table>";
			strResult+="</td>";
			strResult+="</tr>";
		
		}
		else
		{
			strResult+="<tr height=\"50\">";
			strResult+="<td  align=\"center\" class=\"bold\">No Result Found.</td>";
			strResult+="</tr>";
		}
		
		strResult+="</table>";
		return strResult;
	}
	
	private double dateDiff(String firstDate, String lastDate)
	{
		double diff = 0l;
		try
		{
			java.util.Date date1 = java.sql.Date.valueOf(firstDate);
			java.util.Date date2 = java.sql.Date.valueOf(lastDate);
			
			diff = (double)date2.getTime() - date1.getTime();
			
			
			if(diff == 0)
			{
				diff = 1000 * 60 * 60 * 24;
			}
			diff =  (diff / (1000 * 60 * 60 * 24));
			
		}
		catch (Exception e){
			//System.out.print(e.getStackTrace());
			
		}
		return diff ;
	}
}
